<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>JLPT N3/N2 Flashcards</title>
<style>
  :root{--bg:#fff;--fg:#111;--muted:#666;--line:#e6e6e6;--btn:#f6f6f6;--btn2:#111;--btnfg:#111;--btn2fg:#fff;--radius:14px;--cardw:min(720px,92vw);--cardbg:rgba(255,255,255,0.45)}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.45 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial}
  .wrap{max-width:920px;margin:0 auto;padding:18px}
  header{display:flex;flex-wrap:wrap;align-items:center;gap:10px 12px;margin-bottom:12px}
  h1{font-size:18px;margin:0 12px 0 0;letter-spacing:.2px}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px}
  .btn{border:1px solid var(--line);background:var(--btn);color:var(--btnfg);padding:10px 14px;border-radius:999px;cursor:pointer}
  .btn.primary{background:var(--btn2);color:var(--btn2fg)}
  .spacer{flex:1}
  .stats{margin:6px 0 14px;font-variant-numeric:tabular-nums;color:#222}
  .panel{border:1px solid var(--line);border-radius:16px;padding:16px;background:#fff}
  .card{background:var(--cardbg);border:1px solid var(--line);border-radius:16px;padding:24px;min-height:200px;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center}
  .kana{font-size:18px;color:var(--muted);margin-bottom:8px}
  .word{font-size:36px;line-height:1.1;margin:2px 0}
  .meaning{font-size:18px;margin:10px 0 4px}
  .example{font-size:15px;color:var(--muted)}
  .controls{display:flex;gap:10px;justify-content:center;margin-top:14px;flex-wrap:wrap}
  .footer{margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  select{appearance:none;background:var(--btn);color:var(--fg);border:1px solid var(--line);border-radius:10px;padding:10px 12px;min-width:160px}
  .small{font-size:13px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>JLPT N3/N2 Flashcards</h1>
    <div class="toolbar">
      <button class="btn primary" id="btnStudy">Study</button>
      <button class="btn" id="btnReview">Review</button>
      <button class="btn" id="btnReset">Reset Progress</button>
    </div>
    <span class="spacer"></span>
    <select id="deckSelect"></select>
  </header>

  <div class="stats" id="statsLine">Total 0 · Learned 0 · Review 0 · Not 0</div>

  <div class="panel">
    <div class="card" id="card">
      <div class="kana" id="cardKana">かな</div>
      <div class="word" id="cardWord">言葉</div>
      <div class="meaning" id="cardMeaning">word; vocabulary</div>
      <div class="example" id="cardExample">例文：新しい言葉を毎日覚えたい。</div>
    </div>
    <div class="controls">
      <button class="btn" id="markReview">Mark Review</button>
      <button class="btn" id="markLearned">Mark Learned</button>
      <button class="btn" id="nextCard">Next ▶</button>
    </div>
    <div class="footer">
      <select id="modeSelect">
        <option value="all">All cards</option>
        <option value="not">Only Not</option>
        <option value="review">Only Review</option>
        <option value="learned">Only Learned</option>
      </select>
      <select id="shuffleSelect">
        <option value="on">Shuffled</option>
        <option value="off">In order</option>
      </select>
      <span class="spacer"></span>
      <div class="small" id="cursorInfo">Card 0 / 0</div>
    </div>
  </div>
</div>

<script>
  const STORAGE_KEY="nihongo_status_v2";
  const state={decks:{},order:[],currentDeckKey:null,pool:[],cursor:0,statuses:{}};
  const DECK_MANIFEST=["data/n2_core.json","data/n3_core.json"];

  function loadStatuses(){try{state.statuses=JSON.parse(localStorage.getItem(STORAGE_KEY)||"{}")}catch(e){state.statuses={}}}
  function saveStatuses(){localStorage.setItem(STORAGE_KEY,JSON.stringify(state.statuses))}
  function setStatus(id,val){state.statuses[id]=val;saveStatuses()}
  function getStatus(id){return state.statuses[id]||"not"}
  function uid(c,i){return c.id||(c.kanji+"|"+(c.kana||"")+"|"+i)}

  async function loadDecks(){
    state.decks={};
    for(const path of DECK_MANIFEST){
      try{
        const res=await fetch(path,{cache:"no-store"});
        if(!res.ok) continue;
        const arr=await res.json();
        if(!Array.isArray(arr)) continue;
        const key=path.split("/").pop().replace(".json","");
        state.decks[key]=arr.map((c,i)=>({...c,id:uid(c,i)}));
      }catch(e){}
    }
    state.order=Object.keys(state.decks);
    state.currentDeckKey=state.order[0]||null;
  }

  function updateDeckSelect(){
    const sel=document.getElementById("deckSelect");
    sel.innerHTML="";
    state.order.forEach(k=>{const o=document.createElement("option");o.value=k;o.textContent=k;sel.appendChild(o)});
    if(state.currentDeckKey) sel.value=state.currentDeckKey;
  }

  function allCards(){return state.order.flatMap(k=>state.decks[k]||[])}

  function updateStats(){
    const cards=allCards();
    const total=cards.length;
    let learned=0,review=0,nots=0;
    for(const c of cards){
      const s=getStatus(c.id);
      if(s==="learned") learned++; else if(s==="review") review++; else nots++;
    }
    document.getElementById("statsLine").textContent=`Total ${total} · Learned ${learned} · Review ${review} · Not ${nots}`;
  }

  function buildPool(){
    const mode=document.getElementById("modeSelect").value;
    const shuffleOn=document.getElementById("shuffleSelect").value==="on";
    const base=state.currentDeckKey?(state.decks[state.currentDeckKey]||[]):allCards();
    let pool=base.filter(c=>{
      const s=getStatus(c.id);
      if(mode==="all") return true;
      return s===mode;
    });
    if(shuffleOn){
      for(let i=pool.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[pool[i],pool[j]]=[pool[j],pool[i]]}
    }
    state.pool=pool; state.cursor=0; updateCursor();
  }

  function showCard(){
    if(state.pool.length===0){
      document.getElementById("cardKana").textContent="—";
      document.getElementById("cardWord").textContent="No cards";
      document.getElementById("cardMeaning").textContent="Add decks or change filters";
      document.getElementById("cardExample").textContent="";
      updateCursor(); return;
    }
    const c=state.pool[state.cursor];
    document.getElementById("cardKana").textContent=c.kana||"";
    document.getElementById("cardWord").textContent=c.kanji||c.kana||"";
    document.getElementById("cardMeaning").textContent=c.meaning||"";
    document.getElementById("cardExample").textContent=c.example?("例文："+c.example):"";
    updateCursor();
  }

  function updateCursor(){
    const pos=state.pool.length?(state.cursor+1):0;
    document.getElementById("cursorInfo").textContent=`Card ${pos} / ${state.pool.length}`;
  }

  function nextCard(){ if(state.pool.length){ state.cursor=(state.cursor+1)%state.pool.length; showCard(); } }
  function mark(val){ if(!state.pool.length) return; const c=state.pool[state.cursor]; setStatus(c.id,val); updateStats(); nextCard(); }

  function attachUI(){
    document.getElementById("deckSelect").addEventListener("change",e=>{state.currentDeckKey=e.target.value||null; buildPool(); showCard();});
    document.getElementById("modeSelect").addEventListener("change",()=>{buildPool(); showCard();});
    document.getElementById("shuffleSelect").addEventListener("change",()=>{buildPool(); showCard();});
    document.getElementById("btnStudy").addEventListener("click",()=>{document.getElementById("modeSelect").value="all"; buildPool(); showCard();});
    document.getElementById("btnReview").addEventListener("click",()=>{document.getElementById("modeSelect").value="review"; buildPool(); showCard();});
    document.getElementById("btnReset").addEventListener("click",()=>{if(confirm("Reset all progress?")){state.statuses={};saveStatuses();updateStats();buildPool();showCard();}});
    document.getElementById("nextCard").addEventListener("click",nextCard);
    document.getElementById("markLearned").addEventListener("click",()=>mark("learned"));
    document.getElementById("markReview").addEventListener("click",()=>mark("review"));
  }

  (async function init(){
    loadStatuses();
    await loadDecks();
    updateDeckSelect();
    updateStats();
    buildPool();
    showCard();
    attachUI();
  })();
</script>
</body>
</html>
