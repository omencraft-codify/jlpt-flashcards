<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Nihongo Flashcards — Safe Minimal</title>
  <meta name="theme-color" content="#0f1115">
  <style>
    :root {
      --bg: #0f1115; --panel: #111827; --panel2: #141c2b; --text: #e9eef5;
      --muted: #a7b6d3; --line: #253147; --chip: #121826; --chipLine:#2a3144;
      --green:#1f6d3e; --amber:#7a5b1f; --red:#7a2430; --accent:#8db3ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,
      "Hiragino Kaku Gothic ProN","Yu Gothic","Noto Sans JP","Apple Color Emoji","Segoe UI Emoji",sans-serif;
    }
    .app{min-height:100%;max-width:900px;margin:0 auto;padding:16px;display:grid;gap:16px}
    header{display:flex;align-items:center;justify-content:space-between;gap:10px}
    h1{margin:0;font-size:18px;color:#cfe3ff}
    .chip{
      display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;
      font-size:12px;background:var(--chip);border:1px solid var(--chipLine);color:#c6d7fb;white-space:nowrap
    }
    .board{border:1px solid var(--line);border-radius:16px;background:var(--panel);padding:16px;display:grid;gap:12px}
    .counts{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    .card{
      border:1px solid var(--line);border-radius:16px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));
      padding:22px 16px;display:grid;gap:10px;justify-items:center;text-align:center;max-width:820px;margin:0 auto
    }
    .jp{font-size:clamp(28px,8vw,56px);font-weight:800}
    .reading{font-size:clamp(16px,4vw,22px);color:var(--accent)}
    .meaning{font-size:clamp(16px,4vw,21px);color:#dbe7ff}
    .example{border:1px dashed var(--line);border-radius:12px;padding:10px 12px;max-width:760px;background:rgba(255,255,255,.02)}
    .exjp{font-size:clamp(15px,3.8vw,20px)} .exen{font-size:clamp(14px,3.6vw,18px);color:#bcd0ff}
    .meta{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    .buttons{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;max-width:820px;margin:0 auto}
    button{
      appearance:none;border:0;border-radius:14px;padding:16px 14px;font-size:18px;font-weight:650;letter-spacing:.2px;cursor:pointer
    }
    .btnY{background:var(--green);color:#e9fff0}.btnM{background:var(--amber);color:#fff6e0}.btnN{background:var(--red);color:#ffe9ee}
    .row{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;max-width:820px;margin:0 auto}
    .row button,.toggle{background:var(--panel2);border:1px solid var(--line);color:#cdd9f0;border-radius:12px;padding:12px;font-weight:600}
    .toggle{display:flex;align-items:center;justify-content:center;gap:8px}
    .toggle input{width:18px;height:18px}
    .status{text-align:center;font-size:12px;color:#9bb5e7}
    .hidden{display:none!important}
    @media (max-width:520px){.row{grid-template-columns:1fr 1fr}}
    /* modal */
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.65);z-index:50}
    .panel{width:min(94vw,840px);background:var(--panel2);border:1px solid var(--line);border-radius:16px;padding:16px;display:grid;gap:10px}
    .panel textarea{width:100%;min-height:200px;border-radius:12px;background:#0e1422;border:1px solid var(--line);color:#dbe7ff;padding:12px}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Nihongo Flashcards — Safe Minimal</h1>
      <span class="chip" id="modeChip">Mixed practice</span>
    </header>
    <div class="board">
      <div class="counts">
        <span class="chip" id="countTotal">Total: 0</span>
        <span class="chip" id="countKnown">Known: 0</span>
        <span class="chip" id="countReview">Review: 0</span>
        <span class="chip" id="countUnknown">Unknown: 0</span>
      </div>
      <div class="card">
        <div class="jp" id="jp">Loading…</div>
        <div class="reading" id="reading"></div>
        <div class="meaning" id="meaning"></div>
        <div class="example" id="exBox">
          <div class="exjp" id="exjp"></div>
          <div class="exen" id="exen"></div>
        </div>
        <div class="meta">
          <span class="chip" id="levelChip"></span>
          <span class="chip" id="posChip"></span>
        </div>
      </div>
      <div class="buttons">
        <button class="btnY" id="btnY">Know (Y)</button>
        <button class="btnM" id="btnM">Review (M)</button>
        <button class="btnN" id="btnN">Don’t know (N)</button>
      </div>
      <div class="row">
        <label class="toggle"><input type="checkbox" id="togHideMeaning"> Hide meaning</label>
        <label class="toggle"><input type="checkbox" id="togHideReading"> Hide reading</label>
        <label class="toggle"><input type="checkbox" id="togHideExample"> Hide example</label>
      </div>
      <div class="row">
        <button id="btnSkip">Skip</button>
        <button id="btnUndo">Undo</button>
        <button id="btnSummary">Summary</button>
        <button id="btnExport">Export</button>
        <button id="btnImport">Import</button>
        <button id="btnAdd">Add Words</button>
      </div>
      <p class="status" id="status">Status: Initializing…</p>
    </div>
  </div>

  <!-- Add words modal -->
  <div class="modal" id="addModal">
    <div class="panel">
      <h3>Add a batch of words</h3>
      <p>Format per line: <code>jp | reading | meaning | level | pos | example_jp | example_en</code></p>
      <textarea id="addText" placeholder="確かめる | たしかめる | to confirm | N3 | verb | もう一度確かめてください。 | Please check once more."></textarea>
      <div class="row">
        <button id="addCancel">Cancel</button>
        <button id="addSave">Add to Deck</button>
      </div>
    </div>
  </div>

  <script>
  (function(){
    // ---- Safe storage (fallback to memory if blocked) ----
    const memory = {};
    const store = (()=>{
      try{
        const k = "__t"+Math.random();
        localStorage.setItem(k,"1"); localStorage.removeItem(k);
        return {get:(x)=>localStorage.getItem(x), set:(x,v)=>localStorage.setItem(x,v), ok:true};
      }catch(e){
        return {get:(x)=>memory[x]||null, set:(x,v)=>memory[x]=String(v), ok:false};
      }
    })();
    const statusEl = document.getElementById("status");
    const setStatus = (msg)=>{ if(statusEl) statusEl.textContent = "Status: " + msg; };

    // ---- Seed data (with simple examples) ----
    const SEED = [
      {id:"taberu", jp:"食べる", reading:"たべる", en:"to eat", level:"-", pos:"verb", ex_jp:"ゆっくり食べてください。", ex_en:"Please eat slowly."},
      {id:"nomu", jp:"飲む", reading:"のむ", en:"to drink", level:"-", pos:"verb", ex_jp:"水をたくさん飲みます。", ex_en:"I drink a lot of water."},
      {id:"miru", jp:"見る", reading:"みる", en:"to see; to watch", level:"-", pos:"verb", ex_jp:"映画を見るのが好きです。", ex_en:"I like watching movies."},
      {id:"tsukuru", jp:"作る", reading:"つくる", en:"to make; to create", level:"-", pos:"verb", ex_jp:"朝ごはんを作りました。", ex_en:"I made breakfast."},
      {id:"tsukau", jp:"使う", reading:"つかう", en:"to use", level:"-", pos:"verb", ex_jp:"このアプリを毎日使います。", ex_en:"I use this app every day."},
      {id:"akeru", jp:"開ける", reading:"あける", en:"to open", level:"N3", pos:"verb", ex_jp:"窓を開けてもいいですか。", ex_en:"May I open the window?"},
      {id:"shimeru", jp:"閉める", reading:"しめる", en:"to close", level:"N3", pos:"verb", ex_jp:"ドアを閉めてください。", ex_en:"Please close the door."},
      {id:"yobu", jp:"呼ぶ", reading:"よぶ", en:"to call; to invite", level:"N3", pos:"verb", ex_jp:"タクシーを呼びましょう。", ex_en:"Let’s call a taxi."},
      {id:"atsukau", jp:"扱う", reading:"あつかう", en:"to handle; to treat", level:"N2", pos:"verb", ex_jp:"丁寧に扱ってください。", ex_en:"Please handle it carefully."},
      {id:"tamotsu", jp:"保つ", reading:"たもつ", en:"to keep; to maintain", level:"N2", pos:"verb", ex_jp:"品質を保つ。", ex_en:"Maintain quality."},
      {id:"hakaru", jp:"測る", reading:"はかる", en:"to measure", level:"N3", pos:"verb", ex_jp:"体温を測りましたか。", ex_en:"Did you measure your temperature?"},
      {id:"kaizen", jp:"改善", reading:"かいぜん", en:"improvement", level:"N2", pos:"noun", ex_jp:"改善が必要です。", ex_en:"Improvement is needed."},
      {id:"fuyasu", jp:"増やす", reading:"ふやす", en:"to increase", level:"N3", pos:"verb", ex_jp:"在庫を増やす。", ex_en:"Increase the stock."},
      {id:"herasu", jp:"減らす", reading:"へらす", en:"to reduce", level:"N3", pos:"verb", ex_jp:"無駄を減らす。", ex_en:"Reduce waste."},
      {id:"aratameru", jp:"改める", reading:"あらためる", en:"to revise; to change", level:"N2", pos:"verb", ex_jp:"計画を改める。", ex_en:"Revise the plan."}
    ];

    // ---- State & storage helpers ----
    const KEY_P = "nihongo_safe_progress";
    const KEY_C = "nihongo_safe_custom";
    const get = (k,d)=>{ try{ const v=store.get(k); return v?JSON.parse(v):d; }catch(_){ return d; } };
    const set = (k,v)=>{ try{ store.set(k, JSON.stringify(v)); }catch(_){} };

    const state = {
      base: SEED.slice(),
      custom: get(KEY_C, []),
      progress: get(KEY_P, {Y:["taberu","nomu","miru","tsukuru","tsukau","akeru","shimeru"],
                            M:["yobu","tamotsu","hakaru"],
                            N:["atsukau","kaizen","fuyasu","herasu","aratameru"]}),
      history: [], order: [], current: null,
      hideMeaning:false, hideReading:false, hideExample:false
    };

    function deck(){ return state.base.concat(state.custom); }
    function byId(id){ return deck().find(d=>d.id===id); }
    function ensure(){
      const ids = new Set(deck().map(d=>d.id));
      ["Y","M","N"].forEach(k => state.progress[k] = (state.progress[k]||[]).filter(x=>ids.has(x)));
      const known = new Set([...state.progress.Y, ...state.progress.M, ...state.progress.N]);
      deck().forEach(d => { if(!known.has(d.id)) state.progress.N.push(d.id); });
      ["Y","M","N"].forEach(k => state.progress[k]=Array.from(new Set(state.progress[k])));
      set(KEY_P, state.progress);
    }
    ensure();

    // ---- Queue & rendering ----
    function buildQueue(){ state.order = deck().map(d=>d.id).filter(id => state.progress.M.includes(id) || state.progress.N.includes(id)); }
    function nextCard(){
      if(state.order.length===0) buildQueue();
      if(state.order.length===0){
        setText("#jp","No cards"); setText("#reading",""); setText("#meaning",""); setText("#exjp",""); setText("#exen","");
        show("#exBox", false); updateCounts(); setStatus("Ready • No cards in queue"); return;
      }
      state.current = state.order.shift();
      render();
      setStatus("Ready • Cards in queue: " + (state.order.length+1));
    }
    function setText(sel, val){ const el=document.querySelector(sel); if(el) el.textContent = val || ""; }
    function show(sel, on){ const el=document.querySelector(sel); if(el) el.classList.toggle("hidden", !on); }
    function render(){
      const d = byId(state.current); if(!d) return;
      setText("#jp", d.jp); setText("#reading", d.reading); setText("#meaning", d.en);
      setText("#exjp", d.ex_jp||""); setText("#exen", d.ex_en||""); show("#exBox", (!!d.ex_jp||!!d.ex_en) && !state.hideExample);
      document.getElementById("reading").classList.toggle("hidden", state.hideReading);
      document.getElementById("meaning").classList.toggle("hidden", state.hideMeaning);
      setText("#levelChip", d.level||""); setText("#posChip", d.pos||"");
      updateCounts();
    }
    function updateCounts(){
      document.getElementById("countTotal").textContent = "Total: " + deck().length;
      document.getElementById("countKnown").textContent = "Known: " + state.progress.Y.length;
      document.getElementById("countReview").textContent = "Review: " + state.progress.M.length;
      document.getElementById("countUnknown").textContent = "Unknown: " + state.progress.N.length;
    }

    // ---- Actions ----
    function moveTo(id,to){
      const p=state.progress; const from = ["Y","M","N"].find(k=>p[k].includes(id))||"N";
      if(from!==to){
        ["Y","M","N"].forEach(k=>p[k]=p[k].filter(x=>x!==id));
        p[to].push(id); set(KEY_P,p); state.history.push({id,from,to});
      }
      nextCard();
    }
    function undo(){ const last = state.history.pop(); if(!last) return;
      ["Y","M","N"].forEach(k=>state.progress[k]=state.progress[k].filter(x=>x!==last.id));
      state.progress[last.from].push(last.id); set(KEY_P,state.progress); state.order.unshift(last.id); nextCard(); }
    function skip(){ if(!state.current) return; state.order.push(state.current); nextCard(); }

    function exportData(){
      const payload = {progress:state.progress, custom:state.custom, version:"safe-min"};
      const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
      const url = URL.createObjectURL(blob); const a=document.createElement("a");
      a.href=url; a.download="nihongo-flashcards-data.json"; a.click(); setTimeout(()=>URL.revokeObjectURL(url), 800);
    }
    function importData(txt){
      try{
        const obj = JSON.parse(txt);
        if(!obj || !obj.progress || !("custom" in obj)) return alert("Invalid file format.");
        state.custom = Array.isArray(obj.custom)? obj.custom : []; set(KEY_C, state.custom);
        state.progress = obj.progress; ensure(); buildQueue(); nextCard();
      }catch(e){ alert("Could not parse JSON."); }
    }

    function addWordsFrom(text){
      const lines = (text||"").split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      if(!lines.length) return 0; let added=0;
      const existing = new Set(deck().map(d=>`${d.jp}|${d.reading}|${d.en}`));
      lines.forEach(line=>{
        const parts = line.split(/[|,]/).map(s=>s.trim());
        if(parts.length<5) return;
        const [jp,reading,en,level,pos,ex_jp="",ex_en=""]=parts;
        const key=`${jp}|${reading}|${en}`; if(existing.has(key)) return;
        const id="id_"+Math.random().toString(36).slice(2,10);
        state.custom.push({id,jp,reading,en,level,pos,ex_jp,ex_en}); state.progress.N.push(id); added++; existing.add(key);
      });
      set(KEY_C,state.custom); ensure(); buildQueue(); nextCard(); return added;
    }

    // ---- Bind UI ----
    const $ = (s)=>document.querySelector(s);
    $("#btnY").addEventListener("click", ()=>moveTo(state.current,"Y"));
    $("#btnM").addEventListener("click", ()=>moveTo(state.current,"M"));
    $("#btnN").addEventListener("click", ()=>moveTo(state.current,"N"));
    $("#btnUndo").addEventListener("click", undo);
    $("#btnSkip").addEventListener("click", skip);
    $("#btnSummary").addEventListener("click", ()=>{
      const p=state.progress;
      const fmt = (ids)=>ids.map(id=>{const d=byId(id);return d?`${d.jp}（${d.reading}） — ${d.en}`:id;}).join("\n");
      alert(`Known (${p.Y.length}):\n${fmt(p.Y)}\n\nReview (${p.M.length}):\n${fmt(p.M)}\n\nUnknown (${p.N.length}):\n${fmt(p.N)}`);
    });
    $("#btnExport").addEventListener("click", exportData);
    $("#btnImport").addEventListener("click", ()=>{ const t=prompt("Paste exported JSON:"); if(t) importData(t); });
    $("#btnAdd").addEventListener("click", ()=>{ $("#addText").value=""; $("#addModal").style.display="grid"; });
    $("#addCancel").addEventListener("click", ()=>{ $("#addModal").style.display="none"; });
    $("#addSave").addEventListener("click", ()=>{
      const c = addWordsFrom($("#addText").value); alert(c+" word(s) added."); $("#addModal").style.display="none";
    });
    $("#togHideMeaning").addEventListener("change", e=>{ state.hideMeaning=e.target.checked; render(); });
    $("#togHideReading").addEventListener("change", e=>{ state.hideReading=e.target.checked; render(); });
    $("#togHideExample").addEventListener("change", e=>{ state.hideExample=e.target.checked; render(); });

    // ---- Init ----
    function updateCounts(){
      document.getElementById("countTotal").textContent = "Total: " + deck().length;
      document.getElementById("countKnown").textContent = "Known: " + state.progress.Y.length;
      document.getElementById("countReview").textContent = "Review: " + state.progress.M.length;
      document.getElementById("countUnknown").textContent = "Unknown: " + state.progress.N.length;
    }
    buildQueue(); nextCard();
    setStatus("Ready • Buttons active");
  })();
  </script>
</body>
</html>
