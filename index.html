<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>JLPT N3/N2 Flashcards – Dark + Swipe</title>
<style>
  :root{--bg:#fff;--fg:#111;--muted:#666;--line:#e6e6e6;--btn:#f6f6f6;--btn2:#111;--btnfg:#111;--btn2fg:#fff;--radius:14px;--cardw:min(720px,92vw);--cardbg:rgba(255,255,255,0.40)}
  body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.45 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial}
  .wrap{max-width:920px;margin:0 auto;padding:18px}
  header{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin-bottom:12px}
  .group{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  select{appearance:none;background:var(--btn);border:1px solid var(--line);border-radius:12px;padding:10px 12px}
  .pill{border:1px solid var(--line);padding:10px 12px;border-radius:999px;background:var(--btn);cursor:pointer}
  .pill.active{background:var(--fg);color:#fff;border-color:var(--fg)}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border:1px solid var(--line);background:var(--btn);color:var(--btnfg);padding:12px 14px;border-radius:12px;cursor:pointer;transition:background .15s,border-color .15s,color .15s}
  .btn.primary{background:var(--btn2);color:var(--btn2fg);border-color:var(--btn2)}
  .btn.block{width:100%}
  .small{font-size:12px}
  .muted{color:var(--muted)}
  .hidden{display:none !important}

  /* Card */
  .card{position:relative;width:var(--cardw);margin:10px auto;border:1px solid var(--line);border-radius:var(--radius);padding:22px;box-shadow:0 10px 30px rgba(0,0,0,.18);transform:translate3d(0,0,0);will-change:transform;background:var(--cardbg);backdrop-filter:blur(6px)}
  .card.swiping{cursor:grabbing}
  .card.succeed{box-shadow:0 12px 36px rgba(34,197,94,.35)}
  .card.fail{box-shadow:0 12px 36px rgba(239,68,68,.35)}
  .badge{position:absolute;top:10px;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid var(--line);opacity:0;transition:opacity .12s}
  .badge.left{left:10px}
  .badge.right{right:10px}
  .word{font-size:32px;font-weight:700;margin:2px 0 6px}
  .kana{font-size:22px;color:var(--muted);margin-top:2px}
  .meaning{font-size:22px;margin-top:12px;opacity:.02;user-select:none;transition:opacity .15s}
  .meaning.revealed{opacity:1;user-select:auto}
  .ex{margin-top:10px;color:var(--muted)}
  .controls{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:16px}
  .bar{display:flex;gap:8px;align-items:center;justify-content:center;margin:8px 0 4px;color:var(--muted);font-size:12px}
  .progress{height:8px;background:#f2f2f2;border-radius:999px;overflow:hidden}
  .progress>span{display:block;height:100%;background:var(--fg);width:0}
  .section{border:1px solid var(--line);border-radius:var(--radius);padding:16px;background:var(--cardbg);backdrop-filter:blur(6px)}
  .hidden-el{display:none}
  .center{text-align:center}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .spacer{height:8px}
  /* Drill choices */
  .choices{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
  .choice-btn{border:1px solid var(--line);background:var(--btn);color:var(--btnfg);padding:12px 14px;border-radius:12px;cursor:pointer}
  .choice-btn.correct{border-color:#22c55e}
  .choice-btn.wrong{border-color:#ef4444}
  body.dark .choice-btn{background:#141a21;border-color:#4a5160;color:var(--fg)}
  body.dark .choice-btn.correct{border-color:#22c55e}
  body.dark .choice-btn.wrong{border-color:#ef4444}  /* High-contrast dark theme */
  body.dark{
    --bg:#0b0c0f; --fg:#eef0f3; --muted:#c8ced6; --line:#3b414b;
    --btn:#0f141a; --btn2:#eef0f3; --btnfg:#eef0f3; --btn2fg:#0b0c0f;
  }
  body.dark .card{background:var(--cardbg);border-color:#3b414b}
  body.dark .section{background:var(--cardbg);border-color:#3b414b}
  body.dark select,body.dark textarea{background:#0d1218;color:var(--fg);border-color:#4a5160}
  body.dark .pill{background:#121721;border-color:#6a7384;color:#e9edf5}
  body.dark .pill.active{background:transparent;border-color:#e9edf5;color:#e9edf5;box-shadow:0 0 0 1px #e9edf5 inset}
  body.dark .btn{background:#141a21;border-color:#4a5160;color:var(--fg)}
  body.dark .btn.primary{background:var(--btn2);color:var(--btn2fg);border-color:var(--btn2)}
  body.dark .progress{background:#161c22}
  body.dark .kana{color:#d6dbe3}
  body.dark .muted{color:#cbd2db}

  /* Background image layer with default gradient */
  body::before{content:"";position:fixed;inset:0;background-image:var(--bgimg,linear-gradient(135deg,rgba(2,6,23,.85),rgba(30,58,138,.65)));background-size:cover;background-position:center;background-repeat:no-repeat;opacity:var(--bgimgOpacity,.2);transition:opacity .2s ease;pointer-events:none;z-index:-1}
  details.bg-controls{position:fixed !important; top:12px !important; right:12px !important; left:auto !important; z-index:1000; display:block}
  details.bg-controls summary{list-style:none;cursor:pointer}
  details.bg-controls summary::-webkit-details-marker{display:none}
  .bg-button{background:rgba(17,17,17,.7);color:#fff;border:1px solid rgba(255,255,255,.2);padding:6px 10px;border-radius:10px;font:13px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .bg-panel{margin-top:8px;background:rgba(17,17,17,.85);color:#fff;border:1px solid rgba(255,255,255,.18);border-radius:12px;padding:10px;min-width:240px;box-shadow:0 12px 28px rgba(0,0,0,.45)}
  .bg-panel .btn{background:rgba(255,255,255,.1);color:#fff;border:1px solid rgba(255,255,255,.2);padding:6px 10px;border-radius:10px;font-size:12px;cursor:pointer;width:100%}
  .bg-panel .small{font-size:12px;opacity:.9}
  .bg-panel input[type=range]{width:100%}
</style>
</head>
<body>
<details class="bg-controls" id="bgMenu">
  <summary class="bg-button" aria-haspopup="true" aria-controls="bgPanel">BG</summary>
  <div id="bgPanel" class="bg-panel">
    <button class="btn" id="uploadBgBtn" title="Upload background image">Upload Image</button>
    <div style="height:8px"></div>
    <div class="small">Opacity</div>
    <input id="bgOpacity" type="range" min="0" max="100" value="20">
    <input id="bgFile" type="file" accept="image/*" class="hidden">
    <div style="height:8px"></div>
    <div class="small">Card Opacity</div>
    <input id="cardOpacity" type="range" min="20" max="95" value="45">
    <div style="height:8px"></div>
    <button class="btn" id="clearBgBtn" title="Remove background image">Clear</button>
    <div style="height:8px"></div>
    <div class="small">Remote BG URLs (one per line)</div>
    <textarea id="bgUrls" placeholder="https://example.com/bg1.jpg
https://example.com/bg2.jpg" style="width:100%;min-height:80px"></textarea>
    <label class="small" style="display:flex;gap:8px;align-items:center;margin-top:6px"><input type="checkbox" id="bgRandom"> Random on load</label>
    <button class="btn" id="bgRandomNow" title="Pick a random BG now">Use Random Now</button>
  </div>
</details>

<div class="wrap">
  <header>
    <div class="group">
      <button class="pill active" data-mode="learn">Learn</button>
      <button class="pill" data-mode="review">Review</button>
      <button class="pill" data-mode="drill">Drill</button>
    </div>
    <div class="group">
      <select id="levelFilter">
        <option value="ALL">All Levels</option>
        <option value="N3">N3</option>
        <option value="N2">N2</option>
      </select>
      <div class="group">
        <label class="small muted">Prompt</label>
        <select id="promptMode">
          <option value="JPEN">JP → EN</option>
          <option value="ENJP">EN → JP</option>
        </select>
      </div>
      <button class="btn" id="themeBtn" aria-pressed="false" title="Toggle dark mode">Dark</button>
      <button class="btn" id="addBatchBtn">Add Batch</button>
      <label class="btn" for="importFile">Import</label>
      <input id="importFile" type="file" accept=".json" class="hidden">
    </div>
  </header>

  <div class="bar">
    <span id="counts" class="muted"></span>
  </div>
  <div class="progress"><span id="progressFill"></span></div>

  <div id="cardZone" class="card center hidden-el">
    <div id="badgeLeft" class="badge left">Not</div>
    <div id="badgeRight" class="badge right">Learned</div>

    <div class="word" id="promptBig"></div>
    <div class="kana" id="promptSub"></div>

    <div class="meaning" id="answerBlock">
      <div id="answerMain"></div>
      <div class="ex" id="exampleBlock"></div>
    </div>

    <div id="choices" class="choices hidden-el"></div>

    <div class="controls">
      <button class="btn" id="notBtn">Not Learned</button>
      <button class="btn primary" id="revealBtn">Next</button>
      <button class="btn" id="learnedBtn">Learned</button>
    </div>
    <div class="spacer"></div>
    <button class="btn block hidden" id="reviewBtn">Add To Review</button>
  </div>

  <div id="emptyState" class="section center">
    <div class="muted">No cards in this view. Switch mode or add a batch.</div>
  </div>

  <div id="batchModal" class="section hidden-el">
    <div class="row">
      <select id="batchLevel">
        <option value="N3">N3</option>
        <option value="N2">N2</option>
      </select>
      <button class="btn" id="closeBatch">Close</button>
    </div>
    <div class="spacer"></div>
    <div class="muted small">Paste JSON with: kanji, kana, meaning, example. Optional: example_en, level.</div>
    <div class="spacer"></div>
    <textarea id="batchInput" placeholder='[{"kanji":"必要","kana":"ひつよう","meaning":"necessary","example":"これは必要です。","example_en":"This is necessary."}]' style="width:100%;min-height:140px"></textarea>
    <div class="spacer"></div>
    <div class="row">
      <button class="btn primary" id="addBatchJson">Add JSON</button>
      <button class="btn" id="addBatchCsv">Add CSV</button>
    </div>
    <div class="spacer"></div>
    <div class="small muted">CSV header: kanji,kana,meaning,example,example_en</div>
  </div>
</div>

<script>
  const STORAGE="jlpt_flash_v7";
  const SETTINGS="jlpt_flash_settings";
  const $=s=>document.querySelector(s);
  const $$=s=>document.querySelectorAll(s);
  function loadSettings(){try{return JSON.parse(localStorage.getItem(SETTINGS)||"{}")}catch(_){return {}}}
  function saveSettings(s){try{const cur=loadSettings();localStorage.setItem(SETTINGS,JSON.stringify(Object.assign({},cur,s)));}catch(e){localStorage.setItem(SETTINGS,JSON.stringify(s));}}
  const settingsBootstrap=loadSettings();
  const state={mode:"learn",level:"ALL",queue:[],current:null,promptMode:settingsBootstrap.promptMode||"JPEN",theme:settingsBootstrap.theme||null,bgDataUrl:settingsBootstrap.bgDataUrl||null,bgOpacity:typeof settingsBootstrap.bgOpacity==='number'?settingsBootstrap.bgOpacity:20,cardOpacity:typeof settingsBootstrap.cardOpacity==='number'?settingsBootstrap.cardOpacity:45,answered:false,drillChoices:[],bgRemoteList:settingsBootstrap.bgRemoteList||"",bgRemoteRandom:!!settingsBootstrap.bgRemoteRandom};

  // Preload decks (subset for brevity)
  const N3=[["必要","ひつよう","necessary","これは必要です。","This is necessary."],["原因","げんいん","cause","原因は何ですか。","What is the cause?"],["役に立つ","やくにたつ","be useful","この本は役に立ちます。","This book is useful."],["到着","とうちゃく","arrival","電車が到着します。","The train arrives."],["出発","しゅっぱつ","departure","九時に出発します。","We depart at 9."],["予定","よてい","plan; schedule","明日の予定を確認します。","I’ll check tomorrow’s plan."],["準備","じゅんび","preparation","会議の準備をします。","I’ll prepare for the meeting."],["注意","ちゅうい","caution; attention","車に注意してください。","Please watch out for cars."],["経験","けいけん","experience","経験がありません。","I have no experience."],["連絡","れんらく","contact","後で連絡します。","I’ll contact you later."],["比較","ひかく","comparison","価格を比較します。","I’ll compare prices."],["相談","そうだん","consultation","先生に相談します。","I’ll consult the teacher."],["確認","かくにん","confirmation","住所を確認してください。","Please confirm the address."],["返事","へんじ","reply","返事を待っています。","I’m waiting for your reply."],["遅刻","ちこく","tardiness","今日は遅刻しました。","I was late today."],["約束","やくそく","promise; appointment","三時に約束があります。","I have an appointment at 3."],["事故","じこ","accident","事故が起きました。","An accident occurred."],["安心","あんしん","relief","安心してください。","Please don’t worry."],["運転","うんてん","driving","安全に運転してください。","Please drive safely."],["住所","じゅうしょ","address","新しい住所を書きます。","I’ll write my new address."],["試験","しけん","exam","来週試験があります。","There’s an exam next week."],["説明","せつめい","explanation","もう一度説明してください。","Please explain again."],["発表","はっぴょう","presentation","結果を発表します。","We’ll announce the results."],["出席","しゅっせき","attendance","授業に出席します。","I’ll attend class."],["欠席","けっせき","absence","今日は欠席です。","I’m absent today."],["復習","ふくしゅう","review","復習をしましょう。","Let’s review."],["予習","よしゅう","prep (study)","予習が大切です。","Preparation matters."],["宿題","しゅくだい","homework","宿題をします。","I’ll do homework."],["練習","れんしゅう","practice","毎日練習します。","I practice every day."],["発音","はつおん","pronunciation","発音が難しい。","Pronunciation is hard."],["意味","いみ","meaning","意味が分かりません。","I don’t understand the meaning."],["翻訳","ほんやく","translation","翻訳してください。","Please translate."],["連休","れんきゅう","long weekend","連休に旅行します。","I’ll travel over the holiday."],["出張","しゅっちょう","business trip","来週出張です。","I’m on a business trip next week."],["引っ越し","ひっこし","moving","引っ越しします。","I’m moving."],["故障","こしょう","breakdown","エレベーターが故障です。","The elevator is out of order."],["修理","しゅうり","repair","車を修理します。","I’ll repair the car."],["天気","てんき","weather","天気がいいです。","The weather is nice."],["温度","おんど","temperature","温度が高いです。","The temperature is high."]].map(a=>({kanji:a[0],kana:a[1],meaning:a[2],example:a[3],example_en:a[4],level:"N3"}))(a=>({kanji:a[0],kana:a[1],meaning:a[2],example:a[3],example_en:a[4],level:"N3"}));
  const N2=[["維持","いじ","maintenance","健康を維持します。","Maintain health."],["改善","かいぜん","improvement","サービスを改善します。","Improve the service."],["対象","たいしょう","target","学生が対象です。","Students are the target."],["傾向","けいこう","tendency; trend","増加の傾向があります。","There is an increasing trend."],["影響","えいきょう","influence; effect","天気の影響を受けます。","It’s affected by weather."],["判断","はんだん","judgment","状況を判断します。","Judge the situation."],["証拠","しょうこ","evidence","証拠が足りません。","There isn’t enough evidence."],["主張","しゅちょう","assertion; claim","彼は主張を通した。","He insisted on his claim."],["否定","ひてい","denial","関与を否定した。","He denied involvement."],["許可","きょか","permission","入場には許可が必要です。","Permission is required."],["期待","きたい","expectation","期待に応えたい。","I want to meet expectations."],["責任","せきにん","responsibility","責任を取ります。","I’ll take responsibility."],["状況","じょうきょう","situation","状況が変わった。","The situation changed."],["可能性","かのうせい","possibility","成功の可能性があります。","There’s a chance of success."],["価値","かち","value","時間の価値は大きい。","Time is valuable."],["機能","きのう","function","この機能を追加します。","We’ll add this feature."],["効率","こうりつ","efficiency","効率を上げる。","Increase efficiency."],["制限","せいげん","restriction","速度に制限があります。","There’s a speed limit."],["提案","ていあん","proposal","提案を検討します。","We’ll consider the proposal."],["対策","たいさく","countermeasure","対策を講じる。","Take measures."],["影響力","えいきょうりょく","influence (power)","影響力が大きい。","Has strong influence."],["観点","かんてん","point of view","別の観点から見る。","See from another view."],["協力","きょうりょく","cooperation","ご協力ください。","Please cooperate."],["競争","きょうそう","competition","競争が激しい。","Competition is fierce."],["成長","せいちょう","growth","市場が成長している。","The market is growing."],["存続","そんぞく","continuation","会社の存続。","Company’s survival."],["導入","どうにゅう","introduction","新制度を導入する。","Introduce a new system."],["認識","にんしき","recognition","問題の認識が不足。","Lack of awareness."],["範囲","はんい","range; scope","範囲を広げる。","Expand the scope."],["変更","へんこう","change","計画を変更する。","Change the plan."]].map(a=>({kanji:a[0],kana:a[1],meaning:a[2],example:a[3],example_en:a[4],level:"N2"}))(a=>({kanji:a[0],kana:a[1],meaning:a[2],example:a[3],example_en:a[4],level:"N2"}));

  function load(){const raw=localStorage.getItem(STORAGE); if(!raw){ const init=[...N3,...N2].map((x,i)=>({id:crypto.randomUUID(),...x,status:"new",seen:0,correct:0,addedAt:Date.now()+i})); localStorage.setItem(STORAGE,JSON.stringify(init)); return init; } try{return JSON.parse(raw)}catch(e){localStorage.removeItem(STORAGE);return load()} }
  function save(all){localStorage.setItem(STORAGE,JSON.stringify(all))}
  function cards(){return load()} function setCards(list){save(list)}

  function setMode(m){state.mode=m; $$(".pill").forEach(p=>p.classList.toggle("active",p.dataset.mode===m)); buildQueue(); draw()}
  function setLevel(v){state.level=v; buildQueue(); draw()}
  function filterByLevel(list){return state.level==="ALL"?list:list.filter(x=>x.level===state.level)}
  function buildQueue(){
    const all=filterByLevel(cards());
    const pools={
      learn: all.filter(x=>x.status==="new"||x.status==="not"),
      review: all.filter(x=>x.status==="review"),
      drill: all.filter(x=>x.status==="review").concat(all.filter(x=>x.status==="not"))
    };
    let mode=state.mode;
    let pool=pools[mode];
    if(pool.length===0){
      const order = mode==="learn" ? ["review","drill","learn"] : mode==="review" ? ["drill","learn","review"] : ["learn","review","drill"];
      for(const m of order){ if(pools[m].length){ mode=m; pool=pools[m]; break; } }
      if(mode!==state.mode){ state.mode=mode; $$(".pill").forEach(p=>p.classList.toggle("active",p.dataset.mode===mode)); }
    }
    state.queue=shuffle(pool);
    state.current=null;
  }
  function shuffle(a){a=[...a]; for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]} return a}
  function nextCard(){
    if(state.queue.length===0){ state.current=null; updateEmptyState(); return; }
    state.current=state.queue.shift();
    const ans=document.getElementById('answerBlock');
    const rb=document.getElementById('revealBtn');
    if(ans) ans.classList.remove('revealed');
    if(rb) rb.textContent = 'Next';
    drawCard(false);
  }
  function updateEmptyState(){
    const has=!!state.current;
    document.getElementById('cardZone').classList.toggle('hidden-el',!has);
    document.getElementById('emptyState').classList.toggle('hidden-el',has);
  }
  function draw(){
    const all=filterByLevel(cards());
    const learned=all.filter(x=>x.status==="learned").length;
    const review=all.filter(x=>x.status==="review").length;
    const notl=all.filter(x=>x.status==="not").length;
    const total=all.length;
    document.getElementById('counts').textContent=`Total ${total} · Learned ${learned} · Review ${review} · Not ${notl}`;
    document.getElementById('progressFill').style.width=(total?Math.round((learned/total)*100):0)+"%";
    document.getElementById('promptMode').value=state.promptMode;
    if(!state.current && state.queue.length>0){ nextCard(); return; }
    updateEmptyState();
  }
  function drawCard(reveal){
    const c=state.current; if(!c) { updateEmptyState(); return; }
    const en=c.meaning; const jp=c.kanji||c.kana; const kana=c.kana||"";
    const exJP=c.example||`これは${c.meaning}です。`;
    const exEN=c.example_en||simpleEN(c.meaning);

    const choicesEl=document.getElementById('choices');
    const ansEl=document.getElementById('answerBlock');

    if(state.mode==='drill'){
      state.answered=false;
      // Build 4 options
      const pool=filterByLevel(cards());
      const distractors=shuffle(pool.filter(x=>x.id!==c.id)).slice(0,3);
      const opts = [{correct:true,item:c}].concat(distractors.map(d=>({correct:false,item:d})));
      state.drillChoices=shuffle(opts);
      // Prompt + hide answer
      if(state.promptMode==="JPEN"){ document.getElementById('promptBig').textContent=jp; document.getElementById('promptSub').textContent=kana; document.getElementById('answerMain').textContent=en; }
      else { document.getElementById('promptBig').textContent=en; document.getElementById('promptSub').textContent=""; document.getElementById('answerMain').textContent=`${jp}${kana?`（${kana}）`:""}`; }
      document.getElementById('exampleBlock').textContent=`例: ${exJP} / ${exEN}`;
      ansEl.classList.remove('revealed');
      // Render options
      const mapLabel = (o)=> state.promptMode==="JPEN" ? o.item.meaning : (o.item.kanji||o.item.kana);
      choicesEl.innerHTML = state.drillChoices.map((o,i)=>`<button class="choice-btn" data-idx="${i}">${mapLabel(o)}</button>`).join('');
      choicesEl.classList.remove('hidden-el');
      const rb=document.getElementById('revealBtn'); if(rb){ rb.textContent='Next'; rb.disabled=true; rb.setAttribute('aria-disabled','true'); }
    } else {
      // Learn/Review: always reveal, hide choices
      if(state.promptMode==="JPEN"){ document.getElementById('promptBig').textContent=jp; document.getElementById('promptSub').textContent=kana; document.getElementById('answerMain').textContent=en; }
      else { document.getElementById('promptBig').textContent=en; document.getElementById('promptSub').textContent=""; document.getElementById('answerMain').textContent=`${jp}${kana?`（${kana}）`:""}`; }
      document.getElementById('exampleBlock').textContent=`例: ${exJP} / ${exEN}`;
      ansEl.classList.add('revealed');
      choicesEl.classList.add('hidden-el'); choicesEl.innerHTML='';
      const rb=document.getElementById('revealBtn'); if(rb){ rb.disabled=false; rb.removeAttribute('aria-disabled'); rb.textContent='Next'; }
    }
    // Hide the separate Review button in all modes (Next adds to review)
    const reviewBtn = document.getElementById('reviewBtn'); if(reviewBtn){ reviewBtn.classList.add('hidden'); }
    updateEmptyState();
  }
  function simpleEN(meaning){ return (/^(to\s)/i.test(meaning) ? meaning.replace(/^to\s/i,"").replace(/^\w/,m=>m.toUpperCase()) : `This is ${meaning}.`).replace(/\.$/,"."); }

  function markStatus(status){
    const c=state.current; if(!c) return; const all=cards();
    const idx=all.findIndex(x=>x.id===c.id);
    if(idx!==-1){
      const item={...all[idx]};
      item.seen=(item.seen||0)+1;
      if(status==='learned'){ item.status='learned'; item.correct=(item.correct||0)+1; }
      else if(status==='review'){ item.status='review'; }
      else if(status==='not'){ item.status='not'; }
      all[idx]=item; setCards(all);
    }
    nextCard();
  }

  function importJSON(text,level){ let arr=JSON.parse(text); arr=Array.isArray(arr)?arr:[arr]; const now=Date.now(); const cleaned=arr.map((x,i)=>({ id:crypto.randomUUID(), kanji:String(x.kanji||"").trim(), kana:String(x.kana||"").trim(), meaning:String(x.meaning||"").trim(), example:String(x.example||"").trim(), example_en:String(x.example_en||"").trim(), level:level||String(x.level||"N3").toUpperCase(), status:"new",seen:0,correct:0,addedAt:now+i })).filter(x=>x.meaning && (x.kanji||x.kana)); const all=cards().concat(cleaned); setCards(all); buildQueue(); draw(); }
  function importCSV(text,level){ const lines=text.split(/\r?\n/).filter(Boolean); if(lines.length===0) return; const header=lines[0].split(",").map(h=>h.trim().toLowerCase()); const idx=(k)=>header.indexOf(k); const out=[]; for(let i=1;i<lines.length;i++){ const cols=splitCSVLine(lines[i]); out.push({ kanji:cols[idx("kanji")]||"", kana:cols[idx("kana")]||"", meaning:cols[idx("meaning")]||"", example:cols[idx("example")]||"", example_en:cols[idx("example_en")]||"" }); } importJSON(JSON.stringify(out),level); }
  function splitCSVLine(line){ const r=[];let cur="";let q=false; for(let i=0;i<line.length;i++){ const ch=line[i]; if(ch==='"'){ if(q&&line[i+1]==='"'){cur+='"';i++;} else{q=!q}} else if(ch===','&&!q){r.push(cur);cur="";} else{cur+=ch} } r.push(cur); return r.map(s=>s.trim()); }
  function handleImportFile(e){ const f=e.target.files&&e.target.files[0]; if(!f) return; const reader=new FileReader(); reader.onload=()=>{ try{ importJSON(String(reader.result)); alert('Import complete'); }catch(err){ alert('Import failed'); } finally { buildQueue(); draw(); } }; reader.readAsText(f); e.target.value=''; }

  // Theme + background
  function setTheme(mode){ document.body.classList.toggle('dark', mode==='dark'); const btn=document.getElementById('themeBtn'); if(btn){ btn.textContent = mode==='dark' ? 'Light' : 'Dark'; btn.setAttribute('aria-pressed', mode==='dark'?'true':'false'); } state.theme=mode; saveSettings({theme:mode}); applyCardOpacity(); }
  function applyBackground(){ if(state.bgDataUrl){ document.documentElement.style.setProperty('--bgimg', `url('${state.bgDataUrl}')`);} else { document.documentElement.style.removeProperty('--bgimg'); } document.documentElement.style.setProperty('--bgimgOpacity', String((state.bgOpacity||0)/100)); const slider=document.getElementById('bgOpacity'); if(slider) slider.value=String(state.bgOpacity||0); }
  function applyCardOpacity(){ const dark=document.body.classList.contains('dark'); const alpha=Math.max(0,Math.min(1,(state.cardOpacity||45)/100)); const val = dark ? `rgba(17,22,28,${alpha})` : `rgba(255,255,255,${alpha})`; document.documentElement.style.setProperty('--cardbg', val); const s=document.getElementById('cardOpacity'); if(s) s.value=String(state.cardOpacity||45); }
  (function(){ const prefersDark=window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches; setTheme(state.theme|| (prefersDark?'dark':'light')); applyBackground(); applyCardOpacity(); if(state.bgRemoteRandom) setRandomBgFromList(false); })();

  // Background controls wiring (guarded against missing elements)
  const fileInput=document.getElementById('bgFile');
  const uploadBtn=document.getElementById('uploadBgBtn');
  const opacityInput=document.getElementById('bgOpacity');
  const cardOpacityInput=document.getElementById('cardOpacity');
  const clearBtn=document.getElementById('clearBgBtn');
  if(uploadBtn && fileInput){ uploadBtn.addEventListener('click',()=>fileInput.click()); }
  if(fileInput){ fileInput.addEventListener('change',e=>{ const f=e.target.files&&e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ state.bgDataUrl=String(r.result); saveSettings({bgDataUrl:state.bgDataUrl}); applyBackground(); }; r.readAsDataURL(f); e.target.value=''; }); }
  if(opacityInput){ opacityInput.addEventListener('input',e=>{ state.bgOpacity=parseInt(e.target.value,10)||0; saveSettings({bgOpacity:state.bgOpacity}); applyBackground(); }); }
  if(cardOpacityInput){ cardOpacityInput.addEventListener('input',e=>{ state.cardOpacity=parseInt(e.target.value,10)||45; saveSettings({cardOpacity:state.cardOpacity}); applyCardOpacity(); }); }
  if(clearBtn){ clearBtn.addEventListener('click',()=>{ state.bgDataUrl=null; saveSettings({bgDataUrl:null}); applyBackground(); }); }
  // Remote BG controls
  const bgUrls=document.getElementById('bgUrls');
  const bgRandom=document.getElementById('bgRandom');
  const bgRandomNow=document.getElementById('bgRandomNow');
  function setRandomBgFromList(manual){
    const list=(state.bgRemoteList||'').split(/
+/).map(s=>s.trim()).filter(Boolean);
    if(!list.length) return;
    const pick=list[Math.floor(Math.random()*list.length)];
    const url=pick+(pick.includes('?')?'&':'?')+'t='+(manual?Date.now():Math.floor(Date.now()/3600000));
    state.bgDataUrl=url;
    if(!state.bgRemoteRandom){ saveSettings({bgDataUrl:state.bgDataUrl}); }
    applyBackground();
  }
  if(bgUrls){ bgUrls.value=state.bgRemoteList||''; bgUrls.addEventListener('change',e=>{ state.bgRemoteList=e.target.value; saveSettings({bgRemoteList:state.bgRemoteList}); }); }
  if(bgRandom){ bgRandom.checked=!!state.bgRemoteRandom; bgRandom.addEventListener('change',e=>{ state.bgRemoteRandom=!!e.target.checked; saveSettings({bgRemoteRandom:state.bgRemoteRandom}); }); }
  if(bgRandomNow){ bgRandomNow.addEventListener('click',()=>setRandomBgFromList(true)); }); }

  // Swipe gestures
  (function(){
    const zone=document.getElementById('cardZone');
    const ans=document.getElementById('answerBlock');
    const badgeL=document.getElementById('badgeLeft');
    const badgeR=document.getElementById('badgeRight');
    let startX=0, dx=0, dragging=false;
    function down(e){ dragging=true; startX=(e.touches?e.touches[0].clientX:e.clientX); zone.classList.add('swiping'); }
    function move(e){ if(!dragging) return; const x=(e.touches?e.touches[0].clientX:e.clientX); dx=x-startX; zone.style.transform=`translateX(${dx}px) rotate(${dx*0.03}deg)`; zone.classList.toggle('succeed',dx>60); zone.classList.toggle('fail',dx<-60); if(badgeR) badgeR.style.opacity=String(Math.min(1, Math.max(0,(dx-40)/100))); if(badgeL) badgeL.style.opacity=String(Math.min(1, Math.max(0,(-dx-40)/100))); }
    function reset(){ zone.style.transition='transform .18s ease'; zone.style.transform='translateX(0) rotate(0)'; if(badgeR) badgeR.style.opacity='0'; if(badgeL) badgeL.style.opacity='0'; setTimeout(()=>{ zone.style.transition=''; }, 180); }
    function commit(dir){ zone.style.transition='transform .18s ease'; const off=dir>0?600:-600; const rot=dir>0?15:-15; zone.style.transform=`translateX(${off}px) rotate(${rot}deg)`; if(badgeR) badgeR.style.opacity='0'; if(badgeL) badgeL.style.opacity='0'; setTimeout(()=>{ zone.style.transition=''; zone.style.transform=''; if(!ans.classList.contains('revealed')){ ans.classList.add('revealed'); const rb=document.getElementById('revealBtn'); if(rb) rb.textContent='Next'; } markStatus(dir>0?'learned':'not'); }, 160); }
    function up(){ if(!dragging) return; dragging=false; zone.classList.remove('swiping','succeed','fail'); if(dx>120) { commit(1) } else if(dx<-120) { commit(-1) } else { reset() } dx=0; }
    zone.addEventListener('pointerdown',down); window.addEventListener('pointermove',move); window.addEventListener('pointerup',up);
    zone.addEventListener('touchstart',down,{passive:true}); window.addEventListener('touchmove',move,{passive:true}); window.addEventListener('touchend',up);
    zone.addEventListener('click',()=>{ if(ans && !ans.classList.contains('revealed')){ const btn=document.getElementById('revealBtn'); if(btn) btn.click(); }});
  })();

  // events
  document.getElementById('levelFilter').addEventListener('change',e=>setLevel(e.target.value));
  document.querySelectorAll('.pill').forEach(p=>p.addEventListener('click',()=>{ setMode(p.dataset.mode); }));
  function onPrimaryClick(){
    if(state.mode==='drill'){
      if(!state.answered) return;
      markStatus('review');
      return;
    }
    markStatus('review');
  }
  document.getElementById('revealBtn').addEventListener('click', onPrimaryClick);
  document.getElementById('learnedBtn').addEventListener('click',()=>{if(state.mode==='drill'&&!state.answered)return; if(!ensureReveal())return; markStatus('learned')});
  document.getElementById('notBtn').addEventListener('click',()=>{if(state.mode==='drill'&&!state.answered)return; if(!ensureReveal())return; markStatus('not')});
  document.getElementById('reviewBtn').addEventListener('click',()=>{if(state.mode==='drill'&&!state.answered)return; if(!ensureReveal())return; markStatus('review')});
  document.addEventListener('keydown',e=>{
    if(e.key==='ArrowLeft') document.getElementById('notBtn').click();
    if(e.key==='ArrowRight') document.getElementById('learnedBtn').click();
    if(e.key===' '||e.key==='Enter') document.getElementById('revealBtn').click();
    if(e.key && e.key.toLowerCase()==='r') document.getElementById('reviewBtn').click();
    if(e.key && e.key.toLowerCase()==='t'){ const next=document.body.classList.contains('dark')?'light':'dark'; setTheme(next); }
  });
  document.getElementById('promptMode').addEventListener('change',e=>{ state.promptMode=e.target.value; saveSettings({promptMode:state.promptMode}); drawCard(false); });
  document.getElementById('themeBtn').addEventListener('click',()=>{ const next=document.body.classList.contains('dark')?'light':'dark'; setTheme(next); });
  document.getElementById('addBatchBtn').addEventListener('click',()=>{document.getElementById('batchModal').classList.remove('hidden-el')});
  document.getElementById('closeBatch').addEventListener('click',()=>{document.getElementById('batchModal').classList.add('hidden-el')});
  document.getElementById('addBatchJson').addEventListener('click',()=>{ const t=document.getElementById('batchInput').value.trim(); if(!t){alert('Paste JSON first');return} try{importJSON(t,document.getElementById('batchLevel').value); document.getElementById('batchInput').value=''; document.getElementById('batchModal').classList.add('hidden-el')}catch(e){alert('Invalid JSON')} });
  document.getElementById('addBatchCsv').addEventListener('click',()=>{ const t=document.getElementById('batchInput').value.trim(); if(!t){alert('Paste CSV first');return} try{importCSV(t,document.getElementById('batchLevel').value); document.getElementById('batchInput').value=''; document.getElementById('batchModal').classList.add('hidden-el')}catch(e){alert('Invalid CSV')} });
  document.getElementById('importFile').addEventListener('change',handleImportFile);

  // Drill answer delegation
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('.choice-btn');
    if(!btn) return;
    if(state.mode!=='drill') return;
    if(state.answered) return;
    const idx = parseInt(btn.getAttribute('data-idx'),10);
    const opt = state.drillChoices[idx];
    // mark selections
    state.drillChoices.forEach((o,i)=>{
      const el = document.querySelector(`.choice-btn[data-idx="${i}"]`);
      if(!el) return;
      if(o.correct) el.classList.add('correct');
    });
    if(!opt.correct) btn.classList.add('wrong');
    state.answered=true;
    document.getElementById('answerBlock').classList.add('revealed');
    const rb=document.getElementById('revealBtn'); if(rb){ rb.disabled=false; rb.removeAttribute('aria-disabled'); rb.textContent='Next'; }
  });

  function ensureReveal(){
    const shown=document.getElementById('answerBlock').classList.contains('revealed');
    if(!shown){ document.getElementById('answerBlock').classList.add('revealed'); document.getElementById('revealBtn').textContent='Next'; return false }
    return true;
  }

  // ===== Self-tests (open with ?test=1) =====
  function runTests(){
    console.group('Self-tests');
    const backup=localStorage.getItem(STORAGE);
    try{
      const now=Date.now();
      const deck=[
        {id:'a',kanji:'必要',kana:'ひつよう',meaning:'necessary',example:'これは必要です。',example_en:'This is necessary.',level:'N3',status:'learned',seen:2,correct:2,addedAt:now},
        {id:'b',kanji:'到着',kana:'とうちゃく',meaning:'arrival',example:'電車が到着します。',example_en:'The train arrives.',level:'N3',status:'new',seen:0,correct:0,addedAt:now+1},
        {id:'c',kanji:'改善',kana:'かいぜん',meaning:'improvement',example:'改善が必要です。',example_en:'Improvement is needed.',level:'N3',status:'review',seen:1,correct:0,addedAt:now+2}
      ];
      setCards(deck);

      // Fallback when learn empty
      state.level='ALL'; state.mode='learn';
      setCards(deck.filter(x=>x.status!=='new'&&x.status!=='not')); // no learnables
      buildQueue();
      console.assert(state.mode==='review','fallback to review when learn empty');

      // Learn mode: Next auto-adds to review and advances
      setCards(deck); state.mode='learn'; buildQueue(); nextCard();
      console.assert(document.getElementById('answerBlock').classList.contains('revealed'),'learn: answer revealed');
      console.assert(document.getElementById('revealBtn').textContent==='Next','learn: primary shows Next');
      console.assert(document.getElementById('reviewBtn').classList.contains('hidden'),'learn: review button hidden');
      const firstId = state.current.id; onPrimaryClick();
      const upd1 = cards().find(x=>x.id===firstId); console.assert(upd1.status==='review','learn: Next marks review');

      // Review mode: same streamlined behavior
      state.mode='review'; buildQueue(); nextCard();
      console.assert(document.getElementById('answerBlock').classList.contains('revealed'),'review: answer revealed');
      console.assert(document.getElementById('revealBtn').textContent==='Next','review: primary shows Next');
      console.assert(document.getElementById('reviewBtn').classList.contains('hidden'),'review: review button hidden');
      const rid = state.current.id; onPrimaryClick();
      const upd2 = cards().find(x=>x.id===rid); console.assert(upd2.status==='review','review: Next keeps in review');

      // Drill mode: same streamlined behavior
      state.mode='drill'; buildQueue(); nextCard();
      console.assert(document.getElementById('answerBlock').classList.contains('revealed'),'drill: answer revealed');
      console.assert(document.getElementById('revealBtn').textContent==='Next','drill: primary shows Next');
      console.assert(document.getElementById('reviewBtn').classList.contains('hidden'),'drill: review button hidden');
      const did = state.current.id; onPrimaryClick();
      const upd3 = cards().find(x=>x.id===did); console.assert(upd3.status==='review','drill: Next sets review');

      console.log('All assertions passed');
    }catch(err){ console.error('Tests failed',err); }
    finally{ if(backup!==null) localStorage.setItem(STORAGE,backup); else localStorage.removeItem(STORAGE); buildQueue(); draw(); console.groupEnd(); }
  }
  if(location.search.includes('test=1')) runTests();

  // init
  buildQueue();
  draw();
</script>
</body>
</html>

